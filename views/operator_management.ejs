<!-- --------------------------------------------------------------------------
Timestamp: 2026-01-29
File: views/operator_management.ejs
Purpose: Operator/Admin management page
---------------------------------------------------------------------------- -->
<!DOCTYPE html>
<html>
<head>
  <title>Operator/Admin Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Operator/Admin Management</h2>

    <!-- Create Operator/Admin -->
    <div class="mb-4">
      <form action="/admin/operator/create" method="POST" class="row g-3">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="col-auto">
          <input type="text" name="username" class="form-control" placeholder="Username" required>
        </div>
        <div class="col-auto">
          <input type="password" name="password" class="form-control" placeholder="Password" required>
        </div>
        <div class="col-auto">
          <select name="role" class="form-select" required>
            <option value="operator">Operator</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-success">Create</button>
        </div>
      </form>
    </div>

    <!-- Bulk Actions -->
    <div class="mb-3">
      <select id="bulkOperatorAction" class="form-select d-inline w-auto">
        <option value="">Bulk Action</option>
        <option value="activate">Activate</option>
        <option value="deactivate">Deactivate</option>
        <option value="delete">Delete</option>
      </select>
      <button id="applyOperatorBulkAction" class="btn btn-primary">Apply</button>
    </div>

    <!-- Operators/Admins Table -->
    <div class="table-responsive">
      <table id="operatorsTable" class="table table-striped table-bordered"></table>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      const operatorsTable = $('#operatorsTable').DataTable({
        ajax: '/api/operators',
        columns: [
          { data: 'id', title: '<input type="checkbox" id="selectAllOperators">',
            render: function(data) {
              return `<input type="checkbox" class="operator-select" value="${data}">`;
            },
            orderable: false
          },
          { data: 'id', title: 'ID' },
          { data: 'name', title: 'Username' },
          { data: 'role', title: 'Role' },
          { data: 'active', title: 'Active',
            render: function(data) {
              return data == 1 ? 'Active' : 'Inactive';
            }
          },
          { data: 'created_at', title: 'Created At' },
          {
            data: null,
            title: 'Actions',
            render: function(row) {
              let buttons = '';
              if (row.active == 1) {
                buttons += `<form action="/admin/operator/deactivate" method="POST" style="display:inline">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="id" value="${row.id}">
                  <button type="submit" class="btn btn-warning btn-sm">Deactivate</button>
                </form>`;
              } else {
                buttons += `<form action="/admin/operator/activate" method="POST" style="display:inline">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="id" value="${row.id}">
                  <button type="submit" class="btn btn-success btn-sm">Activate</button>
                </form>`;
              }
              buttons += ` <form action="/admin/operator/delete" method="POST" style="display:inline" onsubmit="return confirmDelete(${row.id}, '${row.name}')">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="id" value="${row.id}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>`;
              return buttons;
            }
          }
        ],
        order: [[5, 'desc']],
        pageLength: 25
      });

      // Select-all checkbox logic
      $('#operatorsTable').on('click', '#selectAllOperators', function() {
        const checked = this.checked;
        $('.operator-select').prop('checked', checked);
      });

      // Bulk action handler
      $('#applyOperatorBulkAction').click(function() {
        const action = $('#bulkOperatorAction').val();
        const ids = $('.operator-select:checked').map(function() { return this.value; }).get();
        if (!action || ids.length === 0) {
          alert('Please select an action and at least one operator.');
          return;
        }
        $.post(`/admin/operator/${action}`, { ids, _csrf: '<%= csrfToken %>' })
          .done(() => operatorsTable.ajax.reload(null, false))
          .fail(() => alert('Bulk action failed.'));
      });
    });

    // Prevent deleting operators with vouchers (client-side check)
    function confirmDelete(id, name) {
      return confirm(`Are you sure you want to delete operator ${name}? Operators with vouchers cannot be deleted.`);
    }
  </script>
</body>
</html>

