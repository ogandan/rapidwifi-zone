<!-- --------------------------------------------------------------------------
Timestamp: 2026-01-29
File: views/audit_logs.ejs
Purpose: Dedicated page for Audit Logs and Payments
---------------------------------------------------------------------------- -->
<!DOCTYPE html>
<html>
<head>
  <title>Audit Logs & Payments</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Audit Logs & Payments</h2>

    <!-- Toolbar -->
    <div class="btn-toolbar mb-4" role="toolbar">
      <div class="btn-group me-2">
        <a href="/admin" class="btn btn-outline-primary">Back to Admin Dashboard</a>
      </div>
      <div class="btn-group">
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <!-- Audit Logs Section -->
    <h4>Audit Logs</h4>
    <div class="mb-3">
      <select id="actionFilter" class="form-select d-inline w-auto">
        <option value="">All Actions</option>
        <option value="voucher_created">Voucher Created</option>
        <option value="voucher_status_change">Voucher Status Change</option>
        <option value="payment_success">Payment Success</option>
        <option value="payment_failed">Payment Failed</option>
      </select>
      <select id="batchTagFilter" class="form-select d-inline w-auto">
        <option value="">All Batch Tags</option>
      </select>
    </div>
    <div class="table-responsive mb-5">
      <table id="auditLogsTable" class="table table-striped table-bordered"></table>
    </div>

    <!-- Payments Section -->
    <h4>Payments</h4>
    <div class="mb-3">
      <select id="statusFilter" class="form-select d-inline w-auto">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="success">Success</option>
        <option value="failed">Failed</option>
      </select>
      <select id="methodFilter" class="form-select d-inline w-auto">
        <option value="">All Methods</option>
        <option value="mobilemoney">Mobile Money</option>
        <option value="cash">Cash</option>
      </select>
    </div>
    <div class="table-responsive">
      <table id="paymentsTable" class="table table-striped table-bordered"></table>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      // âœ… Audit Logs DataTable (fixed URL)
      const auditLogsTable = $('#auditLogsTable').DataTable({
        ajax: '/api/audit-logs',
        columns: [
          { data: 'id', title: 'Log ID' },
          { data: 'voucher_id', title: 'Voucher ID' },
          { data: 'action', title: 'Action' },
          { data: 'username', title: 'Batch Tag' },
          { data: 'profile', title: 'Profile' },
          { data: 'details', title: 'Details' },
          { data: 'channel', title: 'Channel' },
          { data: 'status', title: 'Status' },
          { data: 'timestamp', title: 'Timestamp' }
        ],
        order: [[8, 'desc']],
        pageLength: 50,
        dom: 'Bfrtip',
        buttons: ['csv', 'excel']
      });

      // Audit Logs Filters
      $('#actionFilter').on('change', function () {
        let val = $(this).val();
        auditLogsTable.column(2).search(val ? '^' + val + '$' : '', true, false).draw();
      });
      $('#batchTagFilter').on('change', function () {
        let val = $(this).val();
        auditLogsTable.column(3).search(val ? val : '', true, false).draw();
      });

      // Payments DataTable
      const paymentsTable = $('#paymentsTable').DataTable({
        ajax: '/api/payments',
        columns: [
          { data: 'id', title: 'Payment ID' },
          { data: 'voucher_id', title: 'Voucher ID' },
          { data: 'method', title: 'Method' },
          { data: 'amount', title: 'Amount' },
          { data: 'status', title: 'Status' },
          { data: 'timestamp', title: 'Timestamp' }
        ],
        order: [[5, 'desc']],
        pageLength: 25,
        dom: 'Bfrtip',
        buttons: ['csv', 'excel']
      });

      // Payments Filters
      $('#statusFilter').on('change', function () {
        let val = $(this).val();
        paymentsTable.column(4).search(val ? '^' + val + '$' : '', true, false).draw();
      });
      $('#methodFilter').on('change', function () {
        let val = $(this).val();
        paymentsTable.column(2).search(val ? '^' + val + '$' : '', true, false).draw();
      });

      // Auto-refresh every 30s
      setInterval(() => {
        auditLogsTable.ajax.reload(null, false);
        paymentsTable.ajax.reload(null, false);
      }, 30000);
    });
  </script>
</body>
</html>

